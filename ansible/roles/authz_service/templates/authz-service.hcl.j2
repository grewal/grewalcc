# Consul Service Definition for the Authorization Service (ext_authz)

service {
  name = "authz-service"
  id   = "authz-service-{{ ansible_hostname | default('localhost') }}" // Unique ID per node
  port = {{ authz_service_listen_port | default(9001) }}

  # Optional: Add tags for filtering/discovery
  # tags = ["ext_authz", "security", "go"]

  # Removed incorrect key from here: deregister_critical_after = "1m"

  # Use a simple HTTP health check against the /healthz endpoint
  check {
    id       = "authz-service-health-check"
    name     = "AuthZ Service HTTP Health Check"
    http     = "http://127.0.0.1:{{ authz_service_listen_port | default(9001) }}/healthz"
    method   = "GET"
    interval = "10s" // Check every 10 seconds
    timeout  = "2s"  // Timeout after 2 seconds

    # Mark critical after 3 failures
    failures_before_critical = 3

    # Deregister after 1 minute critical (Correct key name and placement)
    DeregisterCriticalServiceAfter = "1m" # <<< CORRECTED LINE
  }

  // Optional: Meta data if needed later
  // meta = {
  //   version = "1.0.0" // Could be templated
  // }
}
