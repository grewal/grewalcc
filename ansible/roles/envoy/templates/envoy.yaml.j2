# {{ ansible_managed }}
---
admin:
  address:
    socket_address:
      address: "{{envoy_admin_address}}"
      port_value: {{envoy_admin_port}}

static_resources:
  listeners: []

  clusters:
    - name: consul_xds_cluster # For dynamic config from Consul
      type: STRICT_DNS
      connect_timeout: 5s
      lb_policy: ROUND_ROBIN
      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": |-
            type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http2_protocol_options: {} # Enable HTTP/2 for gRPC
      load_assignment:
        cluster_name: consul_xds_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1 # Consul agent
                      port_value: 8502   # Consul gRPC xDS port

dynamic_resources:
  lds_config:
    ads: {}
  cds_config:
    ads: {}
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
      - envoy_grpc:
          cluster_name: consul_xds_cluster # Use the static cluster
    set_node_on_first_message_only: true # Important for Consul xDS

# --- NODE IDENTIFIER ---
node:
  id: edge-envoy-instance-1
  cluster: grewalcc_services
